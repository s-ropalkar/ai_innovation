CREATE DATABASE SMART_DISTRIBUTION;

USE DATABASE SMART_DISTRIBUTION;

CREATE SCHEMA CORE;

USE SCHEMA CORE;
CREATE OR REPLACE TABLE INVENTORY (
    DATE DATE,
    LOCATION STRING,
    PRODUCT_ID STRING,
    PRODUCT_NAME STRING,
    CATEGORY STRING,
    OPENING_STOCK INT,
    RECEIVED INT,
    ISSUED INT,
    CLOSING_STOCK INT,
    DAILY_SALES_AVG FLOAT,
    DAYS_TO_EXPIRY INT,
    LEAD_TIME_DAYS INT
);
CREATE OR REPLACE TABLE NGO_MASTER (
    NGO_ID STRING,
    NGO_NAME STRING,
    LOCATION STRING,
    CATEGORY_ACCEPTED STRING,
    MIN_SHELF_LIFE_DAYS INT,
    DAILY_CAPACITY_UNITS INT,
    CONTACT_EMAIL STRING,
    ACTIVE_FLAG STRING
);
ALTER TABLE NGO_MASTER ADD COLUMN ACTIVE_FLAG_BOOL BOOLEAN;

UPDATE NGO_MASTER
SET ACTIVE_FLAG_BOOL =
    CASE
        WHEN UPPER(ACTIVE_FLAG) = 'Y' THEN TRUE
        ELSE FALSE
    END;

SELECT * from ngo_master;
SELECT COUNT(ngo_name) FROM NGO_MASTER;
SELECT * from inventory;
TRUNCATE TABLE NGO_MASTER;
CREATE OR REPLACE FILE FORMAT NGO_CSV_FMT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
TRIM_SPACE = TRUE
FIELD_OPTIONALLY_ENCLOSED_BY = NONE
ERROR_ON_COLUMN_COUNT_MISMATCH = FALSE;


COPY INTO NGO_MASTER
FROM @%NGO_MASTER/ngo_master.csv
FILE_FORMAT = NGO_CSV_FMT;
SELECT * FROM NGO_MASTER;
ALTER TABLE NGO_MASTER ADD COLUMN ACTIVE_FLAG_BOOL BOOLEAN;

UPDATE NGO_MASTER
SET ACTIVE_FLAG_BOOL =
    CASE
        WHEN UPPER(ACTIVE_FLAG) = 'Y' THEN TRUE
        ELSE FALSE
    END;

SELECT * FROM NGO_MASTER;

ALTER TABLE INVENTORY ADD COLUMN DEMAND_SCORE FLOAT;
ALTER TABLE INVENTORY ADD COLUMN STOCKOUT_DAYS FLOAT;

UPDATE INVENTORY
SET 
    DEMAND_SCORE = 
        CASE 
            WHEN CLOSING_STOCK > 0 THEN DAILY_SALES_AVG / CLOSING_STOCK
            ELSE 0 
        END,
    STOCKOUT_DAYS =
        CASE
            WHEN DAILY_SALES_AVG > 0 THEN CLOSING_STOCK / DAILY_SALES_AVG
            ELSE 999
        END;
ALTER TABLE INVENTORY
ADD COLUMN TARGET_LABEL STRING;

UPDATE INVENTORY
SET TARGET_LABEL =
    CASE
        WHEN DAYS_TO_EXPIRY <= 3 AND DEMAND_SCORE < 0.3 THEN 'DONATE'
        WHEN STOCKOUT_DAYS <= LEAD_TIME_DAYS THEN 'REORDER'
        ELSE 'OK'
    END;

SELECT * from inventory;
DESC TABLE SMART_DISTRIBUTION.CORE.INVENTORY;
ALTER TABLE SMART_DISTRIBUTION.CORE.INVENTORY ADD COLUMN TARGET_LABEL STRING;

UPDATE SMART_DISTRIBUTION.CORE.INVENTORY
SET TARGET_LABEL =
    CASE
        WHEN DAYS_TO_EXPIRY <= 3 AND DEMAND_SCORE < 0.3 THEN 'DONATE'
        WHEN STOCKOUT_DAYS <= LEAD_TIME_DAYS THEN 'REORDER'
        ELSE 'OK'
    END;
SELECT TARGET_LABEL, COUNT(*)
FROM SMART_DISTRIBUTION.CORE.INVENTORY
GROUP BY TARGET_LABEL;
CREATE OR REPLACE VIEW SMART_DISTRIBUTION.CORE.FINAL_PREDICTIONS AS
SELECT
    DATE,
    LOCATION,
    PRODUCT_ID,
    PRODUCT_NAME,
    CATEGORY,
    CLOSING_STOCK,
    DEMAND_SCORE,
    STOCKOUT_DAYS,
    DAYS_TO_EXPIRY,
    TARGET_LABEL AS PREDICTION
FROM SMART_DISTRIBUTION.CORE.INVENTORY;
CREATE OR REPLACE VIEW SMART_DISTRIBUTION.CORE.FINAL_PREDICTIONS AS
SELECT
    DATE,
    LOCATION,
    PRODUCT_ID,
    PRODUCT_NAME,
    CATEGORY,
    CLOSING_STOCK,
    DEMAND_SCORE,
    STOCKOUT_DAYS,
    DAYS_TO_EXPIRY,
    (DEMAND_SCORE / 7) AS DAILY_SALES_AVG,
    TARGET_LABEL AS PREDICTION
FROM SMART_DISTRIBUTION.CORE.INVENTORY;

USE ROLE ACCOUNTADMIN;
USE WAREHOUSE COMPUTE_WH;
CREATE WAREHOUSE IF NOT EXISTS COMPUTE_WH
WAREHOUSE_SIZE = XSMALL
AUTO_SUSPEND = 60
AUTO_RESUME = TRUE;
SHOW STREAMLITS;

SELECT * FROM inventory;
describe table ngo_master;



